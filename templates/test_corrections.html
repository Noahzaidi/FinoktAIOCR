<!DOCTYPE html>
<html>
<head>
    <title>Correction Application Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .corrected-word { background-color: #90EE90; padding: 2px 4px; border-radius: 3px; }
        .original-word { background-color: #FFB6C1; padding: 2px 4px; border-radius: 3px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Correction Application Verification</h1>
    
    <div class="test-section">
        <h2>Test Document: 0658ce7d-3f96-4ca0-afc7-7465a5d5386c</h2>
        <button onclick="testCorrections()">Test Corrections</button>
        <button onclick="location.reload(true)">Hard Refresh (Clear Cache)</button>
        <div id="results"></div>
    </div>
    
    <script>
        async function testCorrections() {
            const docId = '0658ce7d-3f96-4ca0-afc7-7465a5d5386c';
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Loading...</p>';
            
            try {
                // Fetch with cache busting
                const timestamp = new Date().getTime();
                const response = await fetch(`/data/document/${docId}?t=${timestamp}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    resultsDiv.innerHTML = `<p class="error">Error: ${response.status}</p>`;
                    return;
                }
                
                const data = await response.json();
                const ocrData = data.ocrData;
                
                let html = '<h3>Results:</h3>';
                let totalWords = 0;
                let correctedWords = 0;
                let corrections = [];
                
                // Count words and find corrections
                ocrData.pages.forEach(page => {
                    page.blocks.forEach(block => {
                        block.lines.forEach(line => {
                            line.words.forEach(word => {
                                totalWords++;
                                if (word.corrected) {
                                    correctedWords++;
                                    corrections.push({
                                        original: word.original_value,
                                        corrected: word.value,
                                        method: word.correction_method || 'unknown'
                                    });
                                }
                            });
                        });
                    });
                });
                
                if (correctedWords > 0) {
                    html += `<div class="success">`;
                    html += `<h4>✅ SUCCESS! Corrections are being applied</h4>`;
                    html += `<p><strong>Total words:</strong> ${totalWords}</p>`;
                    html += `<p><strong>Corrected words:</strong> ${correctedWords}</p>`;
                    html += `<h4>Applied Corrections:</h4>`;
                    corrections.forEach((c, i) => {
                        html += `<p>${i+1}. [${c.method}] <span class="original-word">${c.original}</span> → <span class="corrected-word">${c.corrected}</span></p>`;
                    });
                    html += '</div>';
                    
                    html += '<h4>Raw Text Preview (with corrections):</h4><pre>';
                    let lineNum = 1;
                    ocrData.pages.forEach((page, pageIdx) => {
                        if (pageIdx > 0) html += `\n--- PAGE ${pageIdx + 1} ---\n`;
                        page.blocks.forEach(block => {
                            block.lines.forEach(line => {
                                const lineText = line.words.map(w => w.value).join(' ');
                                if (lineText.trim()) {
                                    html += `${String(lineNum).padStart(3, ' ')}: ${lineText}\n`;
                                    lineNum++;
                                }
                            });
                        });
                    });
                    html += '</pre>';
                } else {
                    html += `<div class="warning">`;
                    html += `<h4>⚠️ No corrections applied</h4>`;
                    html += `<p>Total words: ${totalWords}</p>`;
                    html += `<p>This could mean:</p>`;
                    html += `<ul>`;
                    html += `<li>No corrections exist for this document, OR</li>`;
                    html += `<li>OCR text has changed and doesn't match correction originals, OR</li>`;
                    html += `<li>Text is already correct</li>`;
                    html += `</ul>`;
                    html += '</div>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error"><p>Error: ${error.message}</p></div>`;
            }
        }
        
        // Auto-run test on load
        window.addEventListener('DOMContentLoaded', testCorrections);
    </script>
</body>
</html>

