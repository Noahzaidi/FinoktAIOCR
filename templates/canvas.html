
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Document - {{ doc_id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>
<body>
    <div class="container review-container">
        <header>
            <h1>Document Review</h1>
            <p>Document ID: <strong id="doc-id">{{ doc_id }}</strong></p>
            <div class="actions">
                <button id="undo-btn" class="btn">Undo</button>
                <button id="redo-btn" class="btn">Redo</button>
                <div class="export-dropdown">
                    <button class="btn dropdown-toggle">Export ‚ñº</button>
                    <div class="dropdown-menu">
                        <a href="/export/{{ doc_id }}?format=json" target="_blank" class="dropdown-item">üìÑ Structured JSON</a>
                        <a href="/raw_ocr/{{ doc_id }}" target="_blank" class="dropdown-item">üîç Raw OCR JSON</a>
                        <a href="/export/{{ doc_id }}?format=csv" target="_blank" class="dropdown-item">üìä Export CSV</a>
                        <a href="/export/{{ doc_id }}?format=xml" target="_blank" class="dropdown-item">üìã Export XML</a>
                    </div>
                </div>
                <a href="/" class="btn">Upload New</a>
            </div>
            
            <!-- Document Classification Info -->
            <div id="classification-info" class="classification-info">
                <div class="classification-badge">
                    <span id="doc-type">Loading...</span>
                    <span id="doc-confidence" class="confidence-score">-</span>
                </div>
                <p id="doc-description" class="doc-description">Loading document type...</p>
            </div>
            
            {% if quality_level %}
            <div class="quality-info">
                <div class="quality-badge quality-{{ quality_level }}">
                    Quality: {{ quality_level.title() }} ({{ overall_quality }})
                </div>
                {% if recommendations %}
                <div class="recommendations">
                    <h4>Recommendations:</h4>
                    <ul>
                        {% for rec in recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </header>
        
        <main class="review-main">
            <!-- Left Panel: OCR Text and Editing -->
            <div id="left-panel" class="review-left-panel">
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="edit">Edit Selection</button>
                    <button class="tab-btn" data-tab="raw-text">Raw OCR Text</button>
                    <button class="tab-btn" data-tab="learning">Learning Stats</button>
                    <button class="tab-btn" data-tab="pages">Pages</button>
                </div>
                
                <div id="edit-tab" class="tab-content active">
                    <h2>Edit Selection</h2>
                    <div id="selection-info">
                        <p>Select a text box on the document viewer to edit.</p>
                        <p><small>Click on any red bounding box to select text for editing.</small></p>
                    </div>
                    <div id="edit-form" class="hidden">
                        <div class="form-group">
                            <label for="text-editor">Corrected Text:</label>
                            <input type="text" id="text-editor" class="form-control">
                        </div>
                        <div class="selected-word-info">
                            <p><strong>Selected:</strong> <span id="original-text"></span></p>
                            <p><strong>Page:</strong> <span id="word-page"></span></p>
                            <p><strong>Position:</strong> <span id="word-position"></span></p>
                        </div>
                        <button id="save-btn" class="btn">Save Correction</button>
                        <p id="save-status"></p>
                    </div>
                </div>
                
                <div id="raw-text-tab" class="tab-content">
                    <h2>Raw OCR Text</h2>
                    <div id="raw-text-container">
                        <textarea id="raw-text-display" readonly class="raw-text-area">
                            Loading OCR text...
                        </textarea>
                        <div class="text-stats">
                            <p><strong>Total Words:</strong> <span id="word-count">-</span></p>
                            <p><strong>Avg Confidence:</strong> <span id="avg-confidence">-</span></p>
                        </div>
                    </div>
                </div>

                <div id="learning-tab" class="tab-content">
                    <h2>üß† Smart Learning System</h2>
                    <div id="learning-container">
                        
                        <div class="learning-section highlight-section">
                            <h3>üìä This Document</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="doc-corrections-count">0</div>
                                    <div class="stat-label">Corrections Made</div>
                                    <div class="stat-description">Manual edits you've made</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="auto-corrections-count">0</div>
                                    <div class="stat-label">Auto-Fixed</div>
                                    <div class="stat-description">Words fixed automatically</div>
                                </div>
                            </div>
                            
                            <div id="auto-corrections-applied" class="corrections-display">
                                <h4>ü§ñ Words Auto-Fixed in This Document:</h4>
                                <div id="auto-corrections-list" class="corrections-container">
                                    <div class="no-data">No auto-corrections yet - upload documents with similar errors to see learning in action!</div>
                                </div>
                            </div>
                        </div>

                        <div class="learning-section">
                            <h3>üéØ Learning Progress</h3>
                            <div class="learning-progress">
                                <div class="progress-item">
                                    <div class="progress-header">
                                        <span class="progress-title">Smart Corrections Learned</span>
                                        <span class="progress-number" id="lexicon-size">0</span>
                                    </div>
                                    <div class="progress-description">Patterns the system now fixes automatically</div>
                                </div>
                                
                                <div class="progress-item">
                                    <div class="progress-header">
                                        <span class="progress-title">Training Samples Collected</span>
                                        <span class="progress-number" id="training-samples">0</span>
                                    </div>
                                    <div class="progress-description">Data prepared for model improvement</div>
                                </div>
                            </div>
                            
                            <div id="recent-corrections" class="recent-activity">
                                <h4>üÜï Recently Learned Patterns:</h4>
                                <ul id="lexicon-list" class="activity-list">
                                    <li class="no-data">No patterns learned yet - make some corrections to see them here!</li>
                                </ul>
                            </div>
                        </div>

                        <div class="learning-section">
                            <h3>‚öôÔ∏è Learning Settings</h3>
                            <div id="config-section">
                                <div class="setting-explanation">
                                    <p><strong>Learning Threshold:</strong> How many times the same correction is needed before the system learns it automatically.</p>
                                    <p><em>Current setting: After <span id="current-threshold" class="threshold-highlight">1</span> correction(s), the system will auto-fix that error in future documents.</em></p>
                                </div>
                                
                                <div class="config-item">
                                    <label for="learning-threshold">Set new threshold:</label>
                                    <input type="number" id="learning-threshold" min="1" max="10" value="1">
                                    <button id="update-threshold-btn" class="btn-small">Apply</button>
                                </div>
                                
                                <div class="config-status">
                                    <p><strong>Auto-correction status:</strong> <span id="auto-correction-status">Loading...</span></p>
                                </div>
                            </div>
                        </div>

                        <div class="learning-section">
                            <h3>üîÑ Advanced</h3>
                            <div id="retraining-section">
                                <div style="padding: 0.75rem; background: #d1ecf1; border-left: 4px solid #0c5460; border-radius: 4px; margin-bottom: 1rem;">
                                    <strong style="color: #0c5460;">‚úÖ Real PyTorch Training Available!</strong>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #0c5460;">
                                        You can now train a real OCR model using PyTorch on your collected samples.
                                    </p>
                                </div>
                                <p>Train and deploy improved OCR models based on your corrections.</p>
                                
                                <div class="retrain-info" style="margin-bottom: 1rem;">
                                    <small>Training samples available: <strong><span id="training-samples-for-retrain">0</span></strong> (need 10+ for training)</small>
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                    <button id="retrain-real-btn" class="btn">üî• Train Real Model</button>
                                    <button id="retrain-stub-btn" class="btn" style="background: #6c757d;">üìù Run Simulation (Stub)</button>
                                </div>
                                
                                <div id="retrain-status"></div>
                            </div>
                        </div>

                        <div class="learning-section">
                            <h3>üöÄ Model Deployment</h3>
                            <div id="deployment-section">
                                <p>Deploy trained models to production or rollback to previous versions.</p>
                                
                                <div id="active-model-info" style="padding: 0.75rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; margin-bottom: 1rem;">
                                    <strong style="color: #155724;">Active Model:</strong>
                                    <div id="active-model-details" style="font-size: 0.85rem; margin-top: 0.5rem; color: #155724;">
                                        <p style="margin: 0.25rem 0;">Loading...</p>
                                    </div>
                                </div>
                                
                                <div id="available-models-list" style="margin-bottom: 1rem;">
                                    <h4 style="margin-bottom: 0.5rem; color: var(--secondary-color);">Available Models:</h4>
                                    <div id="models-list-container" style="max-height: 200px; overflow-y: auto;">
                                        <p style="color: #666; font-style: italic; font-size: 0.85rem;">Loading models...</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <button id="refresh-models-btn" class="btn-small">üîÑ Refresh</button>
                                    <button id="rollback-model-btn" class="btn-small" style="background: #dc3545;">‚Ü©Ô∏è Rollback</button>
                                </div>
                                
                                <div id="deployment-status"></div>
                                
                                <div id="deployment-history" style="margin-top: 1rem;">
                                    <h4 style="margin-bottom: 0.5rem; color: var(--secondary-color);">Recent Deployments:</h4>
                                    <div id="deployment-history-list" style="max-height: 150px; overflow-y: auto; font-size: 0.85rem;">
                                        <p style="color: #666; font-style: italic;">No deployments yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pages-tab" class="tab-content">
                    <h2>Pages</h2>
                    <div id="pages-list" class="pages-list"></div>
                </div>
            </div>
            
            <!-- Draggable splitter between left and right panels -->
            <div id="panel-resizer" class="panel-resizer" role="separator" aria-orientation="vertical" aria-label="Resize panels" tabindex="0"></div>

            <!-- Right Panel: Document Viewer -->
            <div id="right-panel" class="review-right-panel">
                <div class="document-viewer-header">
                    <h2>Document Viewer</h2>
                    <div class="viewer-controls">
                        <span id="page-indicator">Loading...</span>
                        <button id="zoom-out-btn" class="btn-small">‚àí</button>
                        <span id="zoom-level">100%</span>
                        <button id="zoom-in-btn" class="btn-small">+</button>
                    </div>
                </div>
                <div id="document-viewer-container">
                    <div id="pages-container">
                        <!-- Pages will be dynamically added here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="{{ url_for('static', path='/canvas.js') }}"></script>
</body>
</html>
